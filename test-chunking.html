<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunking Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Chunking Test</h1>
    
    <div class="test-section">
        <h3>Test Document Chunking</h3>
        <button onclick="testChunking()">Test Chunking</button>
        <button onclick="clearChunks()">Clear Chunks</button>
        <button onclick="showChunks()">Show All Chunks</button>
        <div id="chunking-output" class="output"></div>
    </div>

    <div class="test-section">
        <h3>Test Document ID Generation</h3>
        <button onclick="testDocumentId()">Test Document ID</button>
        <div id="docid-output" class="output"></div>
    </div>

    <script>
        // Simple hash function for browser compatibility
        function simpleHash(str) {
            let hash = 0
            if (str.length === 0) return hash.toString(16)
            
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i)
                hash = ((hash << 5) - hash) + char
                hash = hash & hash // Convert to 32-bit integer
            }
            
            return Math.abs(hash).toString(16)
        }

        // Document ID generation
        function createDocumentId(fileName, content) {
            const safeContent = content || ''
            const safeFileName = fileName || 'unknown'
            const combined = `${safeFileName}|${safeContent.length}|${safeContent.substring(0, 500)}`
            
            let hash = 0
            for (let i = 0; i < combined.length; i++) {
                const char = combined.charCodeAt(i)
                hash = ((hash << 5) - hash) + char
                hash = hash & hash
            }
            
            return `doc_${Math.abs(hash).toString(36)}`
        }

        // Chunking function
        function chunkRequirement(docId, text, maxChars = 3000, overlap = 300) {
            const clean = text.replace(/\s+/g, " ").trim()
            const chunks = []
            let i = 0, idx = 0
            
            if (clean.length === 0) {
                console.log(`⚠️ Chunking - Empty text provided for doc ${docId}`)
                return []
            }
            
            if (clean.length <= maxChars) {
                const textHash = simpleHash(clean)
                const chunkId = simpleHash(`${docId}|0|${clean}`)
                
                chunks.push({
                    id: chunkId,
                    docId,
                    chunkIndex: 0,
                    text: clean,
                    textHash,
                    tokenCount: Math.ceil(clean.length / 4),
                    createdAt: new Date()
                })
                
                console.log(`🔧 Chunking - Single chunk for short text (${clean.length} chars)`)
                return chunks
            }
            
            while (i < clean.length) {
                const end = Math.min(i + maxChars, clean.length)
                const slice = clean.slice(i, end)
                const textHash = simpleHash(slice)
                const chunkId = simpleHash(`${docId}|${i}|${slice}`)
                
                chunks.push({
                    id: chunkId,
                    docId,
                    chunkIndex: idx++,
                    text: slice,
                    textHash,
                    tokenCount: Math.ceil(slice.length / 4),
                    createdAt: new Date()
                })
                
                if (end >= clean.length) break
                i = end - overlap
            }
            
            return chunks
        }

        // Test chunking
        function testChunking() {
            const output = document.getElementById('chunking-output')
            output.textContent = 'Testing chunking...\n'
            
            try {
                // Test document
                const testText = `This is a test document with multiple requirements.
                
                Requirement 1: User Authentication
                - Users must be able to log in with valid credentials
                - Users must be able to log out
                - Invalid login attempts should be blocked
                
                Requirement 2: Data Processing
                - System must process data in batches
                - Data validation must occur before processing
                - Error handling must be implemented
                
                Requirement 3: Reporting
                - Reports must be generated in PDF format
                - Reports must include date and time stamps
                - Export functionality must be available
                
                This is additional text to make the document longer and ensure multiple chunks are created.
                The chunking system should split this into multiple chunks based on the character limit.
                Each chunk should contain complete requirements and maintain logical flow.`
                
                const docId = createDocumentId('test-document.txt', testText)
                output.textContent += `Document ID: ${docId}\n`
                output.textContent += `Text length: ${testText.length} characters\n\n`
                
                const chunks = chunkRequirement(docId, testText)
                output.textContent += `Created ${chunks.length} chunks:\n`
                
                chunks.forEach((chunk, index) => {
                    output.textContent += `\nChunk ${index + 1}:\n`
                    output.textContent += `  ID: ${chunk.id}\n`
                    output.textContent += `  Index: ${chunk.chunkIndex}\n`
                    output.textContent += `  Length: ${chunk.text.length} chars\n`
                    output.textContent += `  Tokens: ~${chunk.tokenCount}\n`
                    output.textContent += `  Preview: ${chunk.text.substring(0, 100)}...\n`
                })
                
                // Save to localStorage
                const chunksKey = 'testCaseWriter_requirementChunks'
                const existing = JSON.parse(localStorage.getItem(chunksKey) || '[]')
                const updated = [...existing, ...chunks]
                localStorage.setItem(chunksKey, JSON.stringify(updated))
                
                output.textContent += `\n✅ Saved ${chunks.length} chunks to localStorage\n`
                
            } catch (error) {
                output.textContent += `❌ Error: ${error.message}\n`
                console.error('Chunking test error:', error)
            }
        }

        // Test document ID generation
        function testDocumentId() {
            const output = document.getElementById('docid-output')
            output.textContent = 'Testing document ID generation...\n'
            
            try {
                const testCases = [
                    { name: 'empty.txt', content: '' },
                    { name: 'short.txt', content: 'Short content' },
                    { name: 'long.txt', content: 'A'.repeat(1000) },
                    { name: 'special.txt', content: 'File with special chars: !@#$%^&*()' }
                ]
                
                testCases.forEach(testCase => {
                    const docId = createDocumentId(testCase.name, testCase.content)
                    output.textContent += `${testCase.name}: ${docId}\n`
                })
                
            } catch (error) {
                output.textContent += `❌ Error: ${error.message}\n`
                console.error('Document ID test error:', error)
            }
        }

        // Clear chunks
        function clearChunks() {
            const chunksKey = 'testCaseWriter_requirementChunks'
            localStorage.removeItem(chunksKey)
            document.getElementById('chunking-output').textContent = 'Chunks cleared from localStorage'
        }

        // Show chunks
        function showChunks() {
            const output = document.getElementById('chunking-output')
            const chunksKey = 'testCaseWriter_requirementChunks'
            const chunks = JSON.parse(localStorage.getItem(chunksKey) || '[]')
            
            output.textContent = `Found ${chunks.length} chunks in localStorage:\n\n`
            
            if (chunks.length === 0) {
                output.textContent += 'No chunks found'
                return
            }
            
            chunks.forEach((chunk, index) => {
                output.textContent += `Chunk ${index + 1}:\n`
                output.textContent += `  ID: ${chunk.id}\n`
                output.textContent += `  DocID: ${chunk.docId}\n`
                output.textContent += `  Index: ${chunk.chunkIndex}\n`
                output.textContent += `  Length: ${chunk.text.length} chars\n`
                output.textContent += `  Tokens: ~${chunk.tokenCount}\n`
                output.textContent += `  Preview: ${chunk.text.substring(0, 100)}...\n\n`
            })
        }
    </script>
</body>
</html>
