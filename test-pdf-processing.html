<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Processing Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>PDF Processing Test</h1>
    
    <div class="test-section">
        <h3>Test PDF.js Library</h3>
        <button onclick="testPDFJS()">Test PDF.js Import</button>
        <div id="pdfjs-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>Test PDF Worker</h3>
        <button onclick="testWorker()">Test PDF Worker</button>
        <div id="worker-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>Test PDF Processing</h3>
        <button onclick="testPDFProcessing()">Test PDF Processing Function</button>
        <div id="processing-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>Test File Upload</h3>
        <input type="file" id="pdfFile" accept=".pdf" />
        <button onclick="testFileUpload()">Test File Upload</button>
        <div id="file-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>Test Minimal PDF</h3>
        <button onclick="testMinimalPDF()">Test Minimal PDF Structure</button>
        <div id="minimal-output" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `output ${type}`;
            element.textContent = message;
            console.log(message);
        }

        async function testPDFJS() {
            try {
                log('pdfjs-output', 'üì¶ Testing PDF.js import...', 'info');
                const pdfjsLib = await import('https://unpkg.com/pdfjs-dist@5.4.54/build/pdf.min.mjs');
                log('pdfjs-output', '‚úÖ PDF.js imported successfully!\n\nLibrary info:\n' + JSON.stringify({
                    version: pdfjsLib.version,
                    build: pdfjsLib.build,
                    GlobalWorkerOptions: pdfjsLib.GlobalWorkerOptions
                }, null, 2), 'success');
            } catch (error) {
                log('pdfjs-output', '‚ùå PDF.js import failed:\n' + error.message, 'error');
            }
        }

        async function testWorker() {
            try {
                log('worker-output', 'üîß Testing PDF worker...', 'info');
                
                // Test local worker
                try {
                    const response = await fetch('/pdf.worker.min.js');
                    if (response.ok) {
                        log('worker-output', '‚úÖ Local worker found and accessible', 'success');
                    } else {
                        throw new Error('Local worker not found');
                    }
                } catch (localError) {
                    log('worker-output', '‚ö†Ô∏è Local worker failed: ' + localError.message, 'warning');
                    
                    // Test CDN worker
                    try {
                        const cdnResponse = await fetch('https://unpkg.com/pdfjs-dist@5.4.54/build/pdf.worker.min.mjs');
                        if (cdnResponse.ok) {
                            log('worker-output', '‚úÖ CDN worker accessible', 'success');
                        } else {
                            throw new Error('CDN worker not accessible');
                        }
                    } catch (cdnError) {
                        log('worker-output', '‚ùå CDN worker also failed: ' + cdnError.message, 'error');
                    }
                }
            } catch (error) {
                log('worker-output', '‚ùå Worker test failed: ' + error.message, 'error');
            }
        }

        async function testPDFProcessing() {
            try {
                log('processing-output', 'üìÑ Testing PDF processing function...', 'info');
                
                // Try to import the processing function
                const response = await fetch('/api/v1/generate-more?docId=test&settingsHash=test');
                if (response.ok) {
                    log('processing-output', '‚úÖ API endpoint accessible', 'success');
                } else {
                    log('processing-output', '‚ö†Ô∏è API endpoint returned: ' + response.status, 'warning');
                }
                
                // Test if we can create a simple PDF-like structure
                const testData = new Uint8Array([0x25, 0x50, 0x44, 0x46, 0x2D, 0x31, 0x2E, 0x34]);
                const testFile = new File([testData], 'test.pdf', { type: 'application/pdf' });
                
                log('processing-output', '‚úÖ Test file created successfully\n\nFile info:\n' + JSON.stringify({
                    name: testFile.name,
                    type: testFile.type,
                    size: testFile.size,
                    lastModified: testFile.lastModified
                }, null, 2), 'success');
                
            } catch (error) {
                log('processing-output', '‚ùå PDF processing test failed: ' + error.message, 'error');
            }
        }

        async function testFileUpload() {
            try {
                const fileInput = document.getElementById('pdfFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    log('file-output', '‚ö†Ô∏è Please select a PDF file first', 'warning');
                    return;
                }
                
                log('file-output', 'üìÅ Testing file upload...\n\nFile info:\n' + JSON.stringify({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    lastModified: file.lastModified
                }, null, 2), 'info');
                
                // Test file reading
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const header = new TextDecoder().decode(uint8Array.slice(0, 20));
                    
                    log('file-output', '‚úÖ File read successfully\n\nHeader analysis:\n' + header + '\n\nFirst 20 bytes: ' + Array.from(uint8Array.slice(0, 20)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '), 'success');
                    
                    // Check if it's actually a PDF
                    if (header.startsWith('%PDF')) {
                        log('file-output', '‚úÖ Valid PDF header detected!', 'success');
                    } else {
                        log('file-output', '‚ö†Ô∏è File does not start with PDF header. This might not be a valid PDF.', 'warning');
                    }
                    
                } catch (readError) {
                    log('file-output', '‚ùå File reading failed: ' + readError.message, 'error');
                }
                
            } catch (error) {
                log('file-output', '‚ùå File upload test failed: ' + error.message, 'error');
            }
        }

        async function testMinimalPDF() {
            try {
                log('minimal-output', 'üìã Testing minimal PDF structure...', 'info');
                
                // Create a minimal valid PDF structure
                const minimalPDF = new Uint8Array([
                    0x25, 0x50, 0x44, 0x46, 0x2D, 0x31, 0x2E, 0x34, 0x0A, // %PDF-1.4
                    0x25, 0xE2, 0xE3, 0xCF, 0xD3, 0x0A, // Binary comment
                    0x31, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A, // 1 0 obj
                    0x3C, 0x3C, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x2F, 0x43, 0x61, 0x74, 0x61, 0x6C, 0x6F, 0x67, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x73, 0x20, 0x31, 0x20, 0x30, 0x20, 0x52, 0x3E, 0x3E, 0x0A, // <<</Type/Catalog/Pages 1 0 R>>
                    0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A, // endobj
                    0x78, 0x72, 0x65, 0x66, 0x0A, // xref
                    0x30, 0x20, 0x32, 0x0A, // 0 2
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x36, 0x35, 0x35, 0x33, 0x35, 0x20, 0x66, 0x0A, // 0000000000 65535 f
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A, // 0000000000 00000 n
                    0x74, 0x72, 0x61, 0x69, 0x6C, 0x65, 0x72, 0x0A, // trailer
                    0x3C, 0x3C, 0x2F, 0x53, 0x69, 0x7A, 0x65, 0x20, 0x32, 0x3E, 0x3E, 0x0A, // <<</Size 2>>
                    0x73, 0x74, 0x61, 0x72, 0x74, 0x78, 0x72, 0x65, 0x66, 0x0A, // startxref
                    0x31, 0x30, 0x30, 0x0A, // 100
                    0x25, 0x25, 0x45, 0x4F, 0x46 // %%EOF
                ]);
                
                const testFile = new File([minimalPDF], 'test.pdf', { type: 'application/pdf' });
                
                log('minimal-output', '‚úÖ Minimal PDF file created\n\nFile info:\n' + JSON.stringify({
                    name: testFile.name,
                    type: testFile.type,
                    size: testFile.size
                }, null, 2) + '\n\nHeader: ' + new TextDecoder().decode(minimalPDF.slice(0, 8)), 'success');
                
                // Try to process with PDF.js
                try {
                    const pdfjsLib = await import('https://unpkg.com/pdfjs-dist@5.4.54/build/pdf.min.mjs');
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@5.4.54/build/pdf.worker.min.mjs';
                    
                    const loadingTask = pdfjsLib.getDocument({ data: minimalPDF });
                    const pdf = await loadingTask.promise;
                    
                    log('minimal-output', '‚úÖ Minimal PDF processed successfully!\n\nPDF info:\n' + JSON.stringify({
                        numPages: pdf.numPages,
                        fingerprint: pdf.fingerprints[0]
                    }, null, 2), 'success');
                    
                } catch (pdfError) {
                    log('minimal-output', '‚ö†Ô∏è PDF processing failed (expected for minimal PDF): ' + pdfError.message, 'warning');
                }
                
            } catch (error) {
                log('minimal-output', '‚ùå Minimal PDF test failed: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
